/*
 * This file is part of ng2-json-editor.
 * Copyright (C) 2017 CERN.
 *
 * ng2-json-editor is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of the
 * License, or (at your option) any later version.
 *
 * ng2-json-editor is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with ng2-json-editor; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
 * In applying this license, CERN does not
 * waive the privileges and immunities granted to it by virtue of its status
 * as an Intergovernmental Organization or submit itself to any jurisdiction.
 */
import { Injectable } from '@angular/core';
import { ReplaySubject } from 'rxjs';
import { combineLatest } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import * as i0 from "@angular/core";
export class ProblemsService {
    constructor() {
        this.externalCategorizedProblems$ = new ReplaySubject(1);
        this.internalCategorizedProblems$ = new ReplaySubject(1);
        this.externalProblemCount$ = new ReplaySubject(1);
        this.internalProblemCount$ = new ReplaySubject(1);
        this.errorCount$ = this.getTotalDistinctProblemCount$ForType('errors');
        this.warningCount$ = this.getTotalDistinctProblemCount$ForType('warnings');
        this.internalProblemMap$ = new ReplaySubject(1);
        this.internalProblemMap = {};
        this.internalCategorizedProblemMap = { errors: {}, warnings: {} };
        this.externalCategorizedProblemMap = { errors: {}, warnings: {} };
        this.externalProblemCount = { errors: 0, warnings: 0 };
        this.internalProblemCount = { errors: 0, warnings: 0 };
        // set default counts to components
        this.externalProblemCount$.next(this.externalProblemCount);
        this.internalProblemCount$.next(this.internalProblemCount);
    }
    getTotalDistinctProblemCount$ForType(type) {
        const external$ = this.externalProblemCount$
            .pipe(map(counts => counts[type]));
        const internal$ = this.internalProblemCount$
            .pipe(map(counts => counts[type]));
        return combineLatest(external$, internal$, (external, internal) => external + internal)
            .pipe(distinctUntilChanged());
    }
    set externalProblems(problems) {
        const { categorizedProblemMap, errorCount, warningCount } = this.categorizeProblemMap(problems);
        this.externalProblemCount = { errors: errorCount, warnings: warningCount };
        this.externalProblemCount$.next(this.externalProblemCount);
        this.externalCategorizedProblemMap = categorizedProblemMap;
        this.externalCategorizedProblems$.next(this.externalCategorizedProblemMap);
    }
    setInternalProblemsForPath(path, problems) {
        this.internalProblemMap[path] = problems;
        this.internalProblemMap$.next(this.internalProblemMap);
        const categorizedProblems = this.categorizeValidationProblems(problems);
        this.internalProblemCount.errors += categorizedProblems.errors.length - this.internalProblemCountForPath(path, 'errors');
        this.internalProblemCount.warnings += categorizedProblems.warnings.length - this.internalProblemCountForPath(path, 'warnings');
        this.internalProblemCount$.next(this.internalProblemCount);
        this.internalCategorizedProblemMap.errors[path] = categorizedProblems.errors;
        this.internalCategorizedProblemMap.warnings[path] = categorizedProblems.warnings;
        this.internalCategorizedProblems$.next(this.internalCategorizedProblemMap);
    }
    internalProblemCountForPath(path, type) {
        if (this.internalCategorizedProblemMap[type][path]) {
            return this.internalCategorizedProblemMap[type][path].length;
        }
        return 0;
    }
    hasProblem(path) {
        const internalProblems = this.internalCategorizedProblemMap.errors[path];
        const externalProblems = this.externalCategorizedProblemMap.errors[path];
        const internalProblemCount = internalProblems ? internalProblems.length : 0;
        const externalProblemCount = externalProblems ? externalProblems.length : 0;
        return (internalProblemCount + externalProblemCount) > 0;
    }
    categorizeProblemMap(problemMap) {
        const categorizedProblemMap = { errors: {}, warnings: {} };
        let errorCount = 0;
        let warningCount = 0;
        Object.keys(problemMap)
            .map(path => {
            const validationProblems = problemMap[path];
            const categorized = this.categorizeValidationProblems(validationProblems);
            return { path, categorized };
        }).forEach(problemsForPath => {
            categorizedProblemMap.errors[problemsForPath.path] = problemsForPath.categorized.errors;
            categorizedProblemMap.warnings[problemsForPath.path] = problemsForPath.categorized.warnings;
            errorCount += problemsForPath.categorized.errors.length;
            warningCount += problemsForPath.categorized.warnings.length;
        });
        return { categorizedProblemMap, errorCount, warningCount };
    }
    categorizeValidationProblems(validationProblems) {
        const categorized = { errors: [], warnings: [] };
        validationProblems.forEach(error => {
            if (error.type === 'Error') {
                categorized.errors.push(error);
            }
            else {
                categorized.warnings.push(error);
            }
        });
        return categorized;
    }
}
ProblemsService.ɵfac = function ProblemsService_Factory(t) { return new (t || ProblemsService)(); };
ProblemsService.ɵprov = i0.ɵɵdefineInjectable({ token: ProblemsService, factory: ProblemsService.ɵfac });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(ProblemsService, [{
        type: Injectable
    }], function () { return []; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvYmxlbXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvdmFyL3d3dy9odG1sL0Fuc2h1bC1Kb3NoaS9Bbmd1bGFyL0dpdEh1bGZ0SW5jL2pzb24tZWRpdG9yL3Byb2plY3RzL2pzb24tZWRpdG9yL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zaGFyZWQvc2VydmljZXMvcHJvYmxlbXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFckMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBVzNELE1BQU0sT0FBTyxlQUFlO0lBbUIxQjtRQWpCUyxpQ0FBNEIsR0FBRyxJQUFJLGFBQWEsQ0FBZ0MsQ0FBQyxDQUFDLENBQUM7UUFDbkYsaUNBQTRCLEdBQUcsSUFBSSxhQUFhLENBQWdDLENBQUMsQ0FBQyxDQUFDO1FBRTNFLDBCQUFxQixHQUFHLElBQUksYUFBYSxDQUFlLENBQUMsQ0FBQyxDQUFDO1FBQzNELDBCQUFxQixHQUFHLElBQUksYUFBYSxDQUFlLENBQUMsQ0FBQyxDQUFDO1FBQ25FLGdCQUFXLEdBQUcsSUFBSSxDQUFDLG9DQUFvQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2xFLGtCQUFhLEdBQUcsSUFBSSxDQUFDLG9DQUFvQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXRFLHdCQUFtQixHQUFHLElBQUksYUFBYSxDQUEyQixDQUFDLENBQUMsQ0FBQztRQUN0RSx1QkFBa0IsR0FBNkIsRUFBRSxDQUFDO1FBRWxELGtDQUE2QixHQUFrQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxD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QVcsQ0FBQztJQUNyQixDQUFDOzs4RUEzR1UsZUFBZTt1REFBZixlQUFlLFdBQWYsZUFBZTtrREFBZixlQUFlO2NBRDNCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgbmcyLWpzb24tZWRpdG9yLlxuICogQ29weXJpZ2h0IChDKSAyMDE3IENFUk4uXG4gKlxuICogbmcyLWpzb24tZWRpdG9yIGlzIGZyZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vclxuICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAyIG9mIHRoZVxuICogTGljZW5zZSwgb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBuZzItanNvbi1lZGl0b3IgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwgYnV0XG4gKiBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlIEdOVVxuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIG5nMi1qc29uLWVkaXRvcjsgaWYgbm90LCB3cml0ZSB0byB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBJbmMuLFxuICogNTkgVGVtcGxlIFBsYWNlLCBTdWl0ZSAzMzAsIEJvc3RvbiwgTUEgMDIxMTEtMTMwNywgVVNBLlxuICogSW4gYXBwbHlpbmcgdGhpcyBsaWNlbnNlLCBDRVJOIGRvZXMgbm90XG4gKiB3YWl2ZSB0aGUgcHJpdmlsZWdlcyBhbmQgaW1tdW5pdGllcyBncmFudGVkIHRvIGl0IGJ5IHZpcnR1ZSBvZiBpdHMgc3RhdHVzXG4gKiBhcyBhbiBJbnRlcmdvdmVybm1lbnRhbCBPcmdhbml6YXRpb24gb3Igc3VibWl0IGl0c2VsZiB0byBhbnkganVyaXNkaWN0aW9uLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIFNjaGVtYVZhbGlkYXRpb25Qcm9ibGVtcyxcbiAgQ2F0ZWdvcml6ZWRWYWxpZGF0aW9uUHJvYmxlbXMsXG4gIFZhbGlkYXRpb25Qcm9ibGVtLFxuICBQcm9ibGVtQ29sbGVjdGlvblR5cGUsXG4gIFByb2JsZW1Db3VudFxufSBmcm9tICcuLi9pbnRlcmZhY2VzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFByb2JsZW1zU2VydmljZSB7XG5cbiAgcmVhZG9ubHkgZXh0ZXJuYWxDYXRlZ29yaXplZFByb2JsZW1zJCA9IG5ldyBSZXBsYXlTdWJqZWN0PENhdGVnb3JpemVkVmFsaWRhdGlvblByb2JsZW1zPigxKTtcbiAgcmVhZG9ubHkgaW50ZXJuYWxDYXRlZ29yaXplZFByb2JsZW1zJCA9IG5ldyBSZXBsYXlTdWJqZWN0PENhdGVnb3JpemVkVmFsaWRhdGlvblByb2JsZW1zPigxKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGV4dGVybmFsUHJvYmxlbUNvdW50JCA9IG5ldyBSZXBsYXlTdWJqZWN0PFByb2JsZW1Db3VudD4oMSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgaW50ZXJuYWxQcm9ibGVtQ291bnQkID0gbmV3IFJlcGxheVN1YmplY3Q8UHJvYmxlbUNvdW50PigxKTtcbiAgcmVhZG9ubHkgZXJyb3JDb3VudCQgPSB0aGlzLmdldFRvdGFsRGlzdGluY3RQcm9ibGVtQ291bnQkRm9yVHlwZSgnZXJyb3JzJyk7XG4gIHJlYWRvbmx5IHdhcm5pbmdDb3VudCQgPSB0aGlzLmdldFRvdGFsRGlzdGluY3RQcm9ibGVtQ291bnQkRm9yVHlwZSgnd2FybmluZ3MnKTtcblxuICByZWFkb25seSBpbnRlcm5hbFByb2JsZW1NYXAkID0gbmV3IFJlcGxheVN1YmplY3Q8U2NoZW1hVmFsaWRhdGlvblByb2JsZW1zPigxKTtcbiAgcHJpdmF0ZSBpbnRlcm5hbFByb2JsZW1NYXA6IFNjaGVtYVZhbGlkYXRpb25Qcm9ibGVtcyA9IHt9O1xuXG4gIHByaXZhdGUgaW50ZXJuYWxDYXRlZ29yaXplZFByb2JsZW1NYXA6IENhdGVnb3JpemVkVmFsaWRhdGlvblByb2JsZW1zID0geyBlcnJvcnM6IHt9LCB3YXJuaW5nczoge30gfTtcbiAgcHJpdmF0ZSBleHRlcm5hbENhdGVnb3JpemVkUHJvYmxlbU1hcDogQ2F0ZWdvcml6ZWRWYWxpZGF0aW9uUHJvYmxlbXMgPSB7IGVycm9yczoge30sIHdhcm5pbmdzOiB7fSB9O1xuXG4gIHByaXZhdGUgZXh0ZXJuYWxQcm9ibGVtQ291bnQgPSB7IGVycm9yczogMCwgd2FybmluZ3M6IDAgfTtcbiAgcHJpdmF0ZSBpbnRlcm5hbFByb2JsZW1Db3VudCA9IHsgZXJyb3JzOiAwLCB3YXJuaW5nczogMCB9O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8vIHNldCBkZWZhdWx0IGNvdW50cyB0byBjb21wb25lbnRzXG4gICAgdGhpcy5leHRlcm5hbFByb2JsZW1Db3VudCQubmV4dCh0aGlzLmV4dGVybmFsUHJvYmxlbUNvdW50KTtcbiAgICB0aGlzLmludGVybmFsUHJvYmxlbUNvdW50JC5uZXh0KHRoaXMuaW50ZXJuYWxQcm9ibGVtQ291bnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUb3RhbERpc3RpbmN0UHJvYmxlbUNvdW50JEZvclR5cGUodHlwZTogUHJvYmxlbUNvbGxlY3Rpb25UeXBlKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICBjb25zdCBleHRlcm5hbCQgPSB0aGlzLmV4dGVybmFsUHJvYmxlbUNvdW50JFxuICAgICAgLnBpcGUobWFwKGNvdW50cyA9PiBjb3VudHNbdHlwZV0pKTtcbiAgICBjb25zdCBpbnRlcm5hbCQgPSB0aGlzLmludGVybmFsUHJvYmxlbUNvdW50JFxuICAgICAgLnBpcGUobWFwKGNvdW50cyA9PiBjb3VudHNbdHlwZV0pKTtcbiAgICByZXR1cm4gY29tYmluZUxhdGVzdChleHRlcm5hbCQsIGludGVybmFsJCwgKGV4dGVybmFsLCBpbnRlcm5hbCkgPT4gZXh0ZXJuYWwgKyBpbnRlcm5hbClcbiAgICAgIC5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xuICB9XG5cbiAgc2V0IGV4dGVybmFsUHJvYmxlbXMocHJvYmxlbXM6IFNjaGVtYVZhbGlkYXRpb25Qcm9ibGVtcykge1xuICAgIGNvbnN0IHsgY2F0ZWdvcml6ZWRQcm9ibGVtTWFwLCBlcnJvckNvdW50LCB3YXJuaW5nQ291bnQgfSA9IHRoaXMuY2F0ZWdvcml6ZVByb2JsZW1NYXAocHJvYmxlbXMpO1xuXG4gICAgdGhpcy5leHRlcm5hbFByb2JsZW1Db3VudCA9IHsgZXJyb3JzOiBlcnJvckNvdW50LCB3YXJuaW5nczogd2FybmluZ0NvdW50IH07XG4gICAgdGhpcy5leHRlcm5hbFByb2JsZW1Db3VudCQubmV4dCh0aGlzLmV4dGVybmFsUHJvYmxlbUNvdW50KTtcblxuICAgIHRoaXMuZXh0ZXJuYWxDYXRlZ29yaXplZFByb2JsZW1NYXAgPSBjYXRlZ29yaXplZFByb2JsZW1NYXA7XG4gICAgdGhpcy5leHRlcm5hbENhdGVnb3JpemVkUHJvYmxlbXMkLm5leHQodGhpcy5leHRlcm5hbENhdGVnb3JpemVkUHJvYmxlbU1hcCk7XG4gIH1cblxuICBzZXRJbnRlcm5hbFByb2JsZW1zRm9yUGF0aChwYXRoOiBzdHJpbmcsIHByb2JsZW1zOiBBcnJheTxWYWxpZGF0aW9uUHJvYmxlbT4pIHtcbiAgICB0aGlzLmludGVybmFsUHJvYmxlbU1hcFtwYXRoXSA9IHByb2JsZW1zO1xuICAgIHRoaXMuaW50ZXJuYWxQcm9ibGVtTWFwJC5uZXh0KHRoaXMuaW50ZXJuYWxQcm9ibGVtTWFwKTtcblxuICAgIGNvbnN0IGNhdGVnb3JpemVkUHJvYmxlbXMgPSB0aGlzLmNhdGVnb3JpemVWYWxpZGF0aW9uUHJvYmxlbXMocHJvYmxlbXMpO1xuXG4gICAgdGhpcy5pbnRlcm5hbFByb2JsZW1Db3VudC5lcnJvcnMgKz0gY2F0ZWdvcml6ZWRQcm9ibGVtcy5lcnJvcnMubGVuZ3RoIC0gdGhpcy5pbnRlcm5hbFByb2JsZW1Db3VudEZvclBhdGgocGF0aCwgJ2Vycm9ycycpO1xuICAgIHRoaXMuaW50ZXJuYWxQcm9ibGVtQ291bnQud2FybmluZ3MgKz0gY2F0ZWdvcml6ZWRQcm9ibGVtcy53YXJuaW5ncy5sZW5ndGggLSB0aGlzLmludGVybmFsUHJvYmxlbUNvdW50Rm9yUGF0aChwYXRoLCAnd2FybmluZ3MnKTtcbiAgICB0aGlzLmludGVybmFsUHJvYmxlbUNvdW50JC5uZXh0KHRoaXMuaW50ZXJuYWxQcm9ibGVtQ291bnQpO1xuXG4gICAgdGhpcy5pbnRlcm5hbENhdGVnb3JpemVkUHJvYmxlbU1hcC5lcnJvcnNbcGF0aF0gPSBjYXRlZ29yaXplZFByb2JsZW1zLmVycm9ycztcbiAgICB0aGlzLmludGVybmFsQ2F0ZWdvcml6ZWRQcm9ibGVtTWFwLndhcm5pbmdzW3BhdGhdID0gY2F0ZWdvcml6ZWRQcm9ibGVtcy53YXJuaW5ncztcbiAgICB0aGlzLmludGVybmFsQ2F0ZWdvcml6ZWRQcm9ibGVtcyQubmV4dCh0aGlzLmludGVybmFsQ2F0ZWdvcml6ZWRQcm9ibGVtTWFwKTtcbiAgfVxuXG4gIHByaXZhdGUgaW50ZXJuYWxQcm9ibGVtQ291bnRGb3JQYXRoKHBhdGg6IHN0cmluZywgdHlwZTogUHJvYmxlbUNvbGxlY3Rpb25UeXBlKTogbnVtYmVyIHtcbiAgICBpZiAodGhpcy5pbnRlcm5hbENhdGVnb3JpemVkUHJvYmxlbU1hcFt0eXBlXVtwYXRoXSkge1xuICAgICAgcmV0dXJuIHRoaXMuaW50ZXJuYWxDYXRlZ29yaXplZFByb2JsZW1NYXBbdHlwZV1bcGF0aF0ubGVuZ3RoO1xuICAgIH1cbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIGhhc1Byb2JsZW0ocGF0aDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgaW50ZXJuYWxQcm9ibGVtcyA9IHRoaXMuaW50ZXJuYWxDYXRlZ29yaXplZFByb2JsZW1NYXAuZXJyb3JzW3BhdGhdO1xuICAgIGNvbnN0IGV4dGVybmFsUHJvYmxlbXMgPSB0aGlzLmV4dGVybmFsQ2F0ZWdvcml6ZWRQcm9ibGVtTWFwLmVycm9yc1twYXRoXTtcbiAgICBjb25zdCBpbnRlcm5hbFByb2JsZW1Db3VudCA9IGludGVybmFsUHJvYmxlbXMgPyBpbnRlcm5hbFByb2JsZW1zLmxlbmd0aCA6IDA7XG4gICAgY29uc3QgZXh0ZXJuYWxQcm9ibGVtQ291bnQgPSBleHRlcm5hbFByb2JsZW1zID8gZXh0ZXJuYWxQcm9ibGVtcy5sZW5ndGggOiAwO1xuICAgIHJldHVybiAoaW50ZXJuYWxQcm9ibGVtQ291bnQgKyBleHRlcm5hbFByb2JsZW1Db3VudCkgPiAwO1xuICB9XG5cbiAgcHJpdmF0ZSBjYXRlZ29yaXplUHJvYmxlbU1hcChwcm9ibGVtTWFwOiBTY2hlbWFWYWxpZGF0aW9uUHJvYmxlbXMpOiB7XG4gICAgY2F0ZWdvcml6ZWRQcm9ibGVtTWFwOiBDYXRlZ29yaXplZFZhbGlkYXRpb25Qcm9ibGVtcyxcbiAgICBlcnJvckNvdW50OiBudW1iZXIsIHdhcm5pbmdDb3VudDogbnVtYmVyXG4gIH0ge1xuICAgIGNvbnN0IGNhdGVnb3JpemVkUHJvYmxlbU1hcCA9IHsgZXJyb3JzOiB7fSwgd2FybmluZ3M6IHt9IH07XG4gICAgbGV0IGVycm9yQ291bnQgPSAwO1xuICAgIGxldCB3YXJuaW5nQ291bnQgPSAwO1xuXG4gICAgT2JqZWN0LmtleXMocHJvYmxlbU1hcClcbiAgICAgIC5tYXAocGF0aCA9PiB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb25Qcm9ibGVtcyA9IHByb2JsZW1NYXBbcGF0aF07XG4gICAgICAgIGNvbnN0IGNhdGVnb3JpemVkID0gdGhpcy5jYXRlZ29yaXplVmFsaWRhdGlvblByb2JsZW1zKHZhbGlkYXRpb25Qcm9ibGVtcyk7XG4gICAgICAgIHJldHVybiB7IHBhdGgsIGNhdGVnb3JpemVkIH07XG4gICAgICB9KS5mb3JFYWNoKHByb2JsZW1zRm9yUGF0aCA9PiB7XG4gICAgICAgIGNhdGVnb3JpemVkUHJvYmxlbU1hcC5lcnJvcnNbcHJvYmxlbXNGb3JQYXRoLnBhdGhdID0gcHJvYmxlbXNGb3JQYXRoLmNhdGVnb3JpemVkLmVycm9ycztcbiAgICAgICAgY2F0ZWdvcml6ZWRQcm9ibGVtTWFwLndhcm5pbmdzW3Byb2JsZW1zRm9yUGF0aC5wYXRoXSA9IHByb2JsZW1zRm9yUGF0aC5jYXRlZ29yaXplZC53YXJuaW5ncztcbiAgICAgICAgZXJyb3JDb3VudCArPSBwcm9ibGVtc0ZvclBhdGguY2F0ZWdvcml6ZWQuZXJyb3JzLmxlbmd0aDtcbiAgICAgICAgd2FybmluZ0NvdW50ICs9IHByb2JsZW1zRm9yUGF0aC5jYXRlZ29yaXplZC53YXJuaW5ncy5sZW5ndGg7XG4gICAgICB9KTtcbiAgICByZXR1cm4geyBjYXRlZ29yaXplZFByb2JsZW1NYXAsIGVycm9yQ291bnQsIHdhcm5pbmdDb3VudCB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjYXRlZ29yaXplVmFsaWRhdGlvblByb2JsZW1zKHZhbGlkYXRpb25Qcm9ibGVtczogQXJyYXk8VmFsaWRhdGlvblByb2JsZW0+KSB7XG4gICAgY29uc3QgY2F0ZWdvcml6ZWQ6IHsgZXJyb3JzOiBBcnJheTxWYWxpZGF0aW9uUHJvYmxlbT4sIHdhcm5pbmdzOiBBcnJheTxWYWxpZGF0aW9uUHJvYmxlbT4gfVxuICAgICAgPSB7IGVycm9yczogW10sIHdhcm5pbmdzOiBbXSB9O1xuICAgIHZhbGlkYXRpb25Qcm9ibGVtcy5mb3JFYWNoKGVycm9yID0+IHtcbiAgICAgIGlmIChlcnJvci50eXBlID09PSAnRXJyb3InKSB7XG4gICAgICAgIGNhdGVnb3JpemVkLmVycm9ycy5wdXNoKGVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhdGVnb3JpemVkLndhcm5pbmdzLnB1c2goZXJyb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjYXRlZ29yaXplZDtcbiAgfVxufVxuIl19